---
// LoginForm.astro - Mejorado con View Transitions y mejor UX
import { actions } from 'astro:actions';

// Get any action result from the current request
const result = Astro.getActionResult(actions.login);
const error = result?.error;
const success = result?.data?.success;
const data = result?.data;

// Check for URL params (logout message, etc.)
const { searchParams } = new URL(Astro.request.url);
const message = searchParams.get('message');
const redirectUrl = searchParams.get('redirect') || '/dashboard';
---

<div class="card w-full" transition:name="login-card">
  <header>
    <h2>Sign in to your account</h2>
    <p>Enter your credentials to access your account</p>
  </header>

  <!-- Display messages -->
  {message === 'logged-out' && (
    <div class="bg-green-50 border border-green-200 text-green-800 rounded-lg p-3 mb-4 text-sm" transition:name="message-banner">
      You have been successfully signed out.
    </div>
  )}

  {message === 'account-created' && (
    <div class="bg-blue-50 border border-blue-200 text-blue-800 rounded-lg p-3 mb-4 text-sm" transition:name="message-banner">
      Account created successfully! Please sign in with your credentials.
    </div>
  )}

  {message === 'session-error' && (
    <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-lg p-3 mb-4 text-sm" transition:name="message-banner">
      Your session has expired. Please sign in again.
    </div>
  )}

  {error && (
    <div class="bg-red-50 border border-red-200 text-red-800 rounded-lg p-3 mb-4 text-sm" transition:name="error-banner">
      {error.message}
    </div>
  )}

  <section transition:name="login-form">
    <form method="POST" action={actions.login} class="form grid gap-6" id="login-form">
      <div class="grid gap-2">
        <label for="email">Email address</label>
        <input 
          type="email" 
          id="email" 
          name="email"
          required
          class="input"
          placeholder="Enter your email"
          value={error ? '' : ''}
          autocomplete="email"
        />
      </div>

      <div class="grid gap-2">
        <div class="flex items-center justify-between">
          <label for="password">Password</label>
          <a href="/auth/forgot-password" class="text-sm text-primary hover:underline">
            Forgot password?
          </a>
        </div>
        <input 
          type="password" 
          id="password" 
          name="password"
          required
          class="input"
          placeholder="Enter your password"
          autocomplete="current-password"
        />
      </div>

      <div class="flex items-center space-x-2">
        <input type="checkbox" id="remember" name="remember" class="rounded">
        <label for="remember" class="text-sm">Remember me</label>
      </div>

      <!-- Hidden redirect field -->
      <input type="hidden" name="redirect_to" value={redirectUrl} />

      <button type="submit" class="btn w-full" id="login-btn" transition:name="submit-button">
        <span class="btn-text">Sign in</span>
        <div class="btn-spinner hidden">
          <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
        </div>
      </button>
    </form>
  </section>

  <footer class="mt-6 text-center">
    <p class="text-sm text-muted-foreground">
      Don't have an account? 
      <a href="/auth/register" class="text-primary hover:underline font-medium">
        Create one here
      </a>
    </p>
  </footer>
</div>

<script>
  interface LoginFormElements extends HTMLFormControlsCollection {
    email: HTMLInputElement;
    password: HTMLInputElement;
    redirect_to: HTMLInputElement;
  }

  interface LoginForm extends HTMLFormElement {
    readonly elements: LoginFormElements;
  }

  // Utility function to show toast notifications
  function showToast(message: string, type: 'success' | 'error' | 'info' | 'warning' = 'info') {
    // Try basecoat event first
    document.dispatchEvent(new CustomEvent('basecoat:toast', {
      detail: {
        config: {
          category: type,
          title: type.charAt(0).toUpperCase() + type.slice(1),
          description: message,
          duration: type === 'success' ? 2000 : 4000,
          cancel: { label: 'Dismiss' }
        }
      }
    }));

    // Also trigger custom app event as fallback
    document.dispatchEvent(new CustomEvent('app:toast', {
      detail: { message, type }
    }));
  }

  // Handle form submission and response
  const loginForm = document.getElementById('login-form') as LoginForm;
  const loginBtn = document.getElementById('login-btn') as HTMLButtonElement;
  const btnText = loginBtn.querySelector('.btn-text');
  const btnSpinner = loginBtn.querySelector('.btn-spinner');
  
  if (loginForm) {
    // Handle form submission
    loginForm.addEventListener('submit', (e) => {
      // Show loading state
      loginBtn.disabled = true;
      btnText?.classList.add('hidden');
      btnSpinner?.classList.remove('hidden');
      
      console.log('ðŸ” Form submitted, showing loading state...');
    });

    // Check if we have action result after page reload
    window.addEventListener('DOMContentLoaded', () => {
      // Check for action result in the page data
      const hasActionResult = document.querySelector('[data-action-result]');
      
      if (hasActionResult) {
        const resultType = hasActionResult.getAttribute('data-result-type');
        const resultMessage = hasActionResult.getAttribute('data-result-message');
        const shouldRedirect = hasActionResult.getAttribute('data-should-redirect') === 'true';
        const redirectTo = hasActionResult.getAttribute('data-redirect-to');
        
        console.log('ðŸ“Š Action result found:', { resultType, resultMessage, shouldRedirect, redirectTo });
        
        if (resultType === 'success' && resultMessage) {
          showToast(resultMessage, 'success');
          
          if (shouldRedirect && redirectTo) {
            console.log(`ðŸ”„ Redirecting with smooth transition to: ${redirectTo}`);
            
            // Use View Transitions API for smooth navigation
            if ('startViewTransition' in document) {
              (document as any).startViewTransition(() => {
                window.location.href = redirectTo;
              });
            } else {
              // Fallback for browsers without View Transitions
              setTimeout(() => {
                window.location.href = redirectTo;
              }, 1500);
            }
          }
        } else if (resultType === 'error' && resultMessage) {
          showToast(resultMessage, 'error');
          resetForm();
        }
      }
    });

    // Handle URL search params for direct success/error messages
    const urlParams = new URLSearchParams(window.location.search);
    const loginStatus = urlParams.get('login');
    const loginError = urlParams.get('error');

    if (loginStatus === 'success') {
      showToast('Welcome back! Redirecting to dashboard...', 'success');
      
      const redirectTo = urlParams.get('redirect') || '/dashboard';
      
      if ('startViewTransition' in document) {
        (document as any).startViewTransition(() => {
          window.location.href = redirectTo;
        });
      } else {
        setTimeout(() => {
          window.location.href = redirectTo;
        }, 1500);
      }
    } else if (loginError) {
      showToast('Login failed. Please check your credentials.', 'error');
      resetForm();
    }
  }

  function resetForm() {
    if (loginBtn) {
      loginBtn.disabled = false;
      btnText?.classList.remove('hidden');
      btnSpinner?.classList.add('hidden');
    }
  }

  // Clear form on back navigation to prevent cached values
  window.addEventListener('pageshow', function(event) {
    if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
      loginForm?.reset();
      resetForm();
    }
  });

  // Auto-focus email field if empty
  document.addEventListener('DOMContentLoaded', () => {
    const emailField = document.getElementById('email') as HTMLInputElement;
    if (emailField && !emailField.value) {
      emailField.focus();
    }
  });
</script>

<style>
  .btn-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  /* View Transitions styling */
  [transition\:name] {
    view-transition-name: var(--transition-name);
  }

  /* Smooth animations for form interactions */
  .input:focus {
    transform: scale(1.01);
    transition: transform 0.2s ease;
  }

  .btn:hover:not(:disabled) {
    transform: translateY(-1px);
    transition: transform 0.2s ease;
  }
</style>

<!-- Hidden element to pass action result data to JavaScript -->
{success && data && (
  <div 
    data-action-result 
    data-result-type="success" 
    data-result-message={data.message}
    data-should-redirect={data.shouldRedirect ? 'true' : 'false'}
    data-redirect-to={data.redirect}
    style="display: none;"
  ></div>
)}

{error && (
  <div 
    data-action-result 
    data-result-type="error" 
    data-result-message={error.message}
    data-should-redirect="false"
    style="display: none;"
  ></div>
)}